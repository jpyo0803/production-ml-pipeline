# -- helm/templates/apps/log-worker.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: log-worker
  namespace: {{ .Values.global.namespace }}
spec:
  replicas: {{ .Values.logWorker.replicaCount }}
  selector:
    matchLabels:
      app: log-worker
  template:
    metadata:
      labels:
        app: log-worker
    spec:
      containers:
      - name: log-worker
        image: {{ .Values.images.logWorker | quote }}
        imagePullPolicy: Always
        env:
        # 공통 S3 환경 변수 주입 (RabbitMQ, MinIO)
        {{- include "common.env.rabbitmq" . | nindent 8 }}
        {{- include "common.env.minio" . | nindent 8 }}

        - name: S3_BUCKET_NAME
          value: "inference-logs"
        - name: BATCH_SIZE
          value: {{ .Values.logWorker.batchSize | quote }}
        - name: FLUSH_INTERVAL
          value: {{ .Values.logWorker.flushInterval | quote }}
        - name: PYTHONUNBUFFERED
          value: "1"

        # 리소스 제한 (OOM 방지)
        resources:
          {{- toYaml .Values.logWorker.resources | nindent 10 }}
