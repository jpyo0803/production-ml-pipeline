# -- helm/templates/jobs/feature-store-job.yaml

apiVersion: batch/v1
kind: Job
metadata:
  name: feature-store-init-job
  namespace: {{ .Values.global.namespace }}
  annotations:
    "helm.sh/hook": post-install # 설치 후에 실행되는 훅
    "helm.sh/hook-weight": "2" # 데이터 업로더 작업 후에 실행 (데이터 업로더는 "1"로 설정) 
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: feature-store-etl
        image: {{ .Values.images.featureStore | quote }}
        workingDir: /app/feast_repo
        # Feature Store ETL 작업 실행
        command:
        - /bin/bash
        - -c
        - |
          echo "[Feature Store] ETL: application features" &&
          python /app/scripts/build_application_features.py &&
          
          echo "[Feature Store] ETL: bureau features" &&
          python /app/scripts/build_bureau_features.py &&
          
          echo "[Feature Store] Feast apply" &&
          cd /app/feast_repo &&
          feast apply &&
          
          echo "[Feature Store] Feast materialize" &&
          feast materialize-incremental $(date +%Y-%m-%d) &&
          
          echo "[Feature Store] Ready"

        env:
        - name: RAW_S3_PREFIX
          value: {{ .Values.featureStore.rawS3Prefix | quote }}
        - name: PROCESSED_S3_PREFIX
          value: {{ .Values.featureStore.processedS3Prefix | quote }}
        # 공통 MinIO 환경 변수 주입
        {{- include "common.env.minio" . | nindent 8 }}
        volumeMounts:
        - name: feast-repo-config
          mountPath: /app/feast_repo/feature_store.yaml
          subPath: feature_store.yaml
        - name: feast-data
          mountPath: /app/feast_repo/data

      volumes:
      - name: feast-repo-config
        configMap:
          name: feast-repo-config
      - name: feast-data
        persistentVolumeClaim:
          claimName: feast-registry-pvc
